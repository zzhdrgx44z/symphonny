<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TOMMY HILFIGER - Enhanced Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<style>
/* ... (styles tetap sama) ... */
</style>
</head>
<body>
<!-- SIDEBAR -->
<div class="sidebar-future">
    <!-- ... (sidebar tetap sama) ... -->
</div>

<!-- MAIN CONTENT -->
<div class="konten-utama">
    <!-- ... (header dan info cards tetap sama) ... -->

    <!-- VIEW TOGGLE BUTTONS -->
    <div class="view-toggle" id="viewToggle" style="display: none;">
        <button class="toggle-btn active" onclick="setTableView('table')">Table View</button>
        <button class="toggle-btn" onclick="setTableView('card')">Card View</button>
    </div>

    <!-- ALL DATA CONTAINER -->
    <div id="allDataContainer" class="all-data-container" style="display: none;"></div>

    <!-- LOADING SPINNER -->
    <div id="loadingSpinner" class="loading-spinner" style="display: none;">
        <div class="spinner"></div>
    </div>

    <!-- CARDS CONTAINER -->
    <div id="kontainerKartu" class="kontainer-kartu">
        <!-- ... (kartu tetap sama) ... -->
    </div>

    <!-- DATA TABLES -->
    <div id="data1"></div>
    <div id="data2"></div>

    <!-- NOT FOUND MESSAGE -->
    <div id="pesanTidakDitemukan">
        <i class="fas fa-exclamation-triangle"></i>
        <strong>DATA NOT FOUND</strong>
        <small>Try again with different keywords</small>
    </div>
</div>

<script>
// =============== GLOBAL VARIABLES ===============
let kategoriSekarang = '';
let semuaData = {
    datalogin: [],
    linknawala: []
};
let sedangMencari = false;
let sidebarCollapsed = false;
let currentView = 'table';

// Google Apps Script URL - SESUAIKAN DENGAN SCRIPT ANDA
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwkHrgiGlxFkJHZwp-bMaRCezwCSPAdV-FyUHkX9cAEWu/exec';

// =============== DEBOUNCE FUNCTION ===============
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// =============== INITIALIZATION ===============
window.onload = function() {
    tampilkanMenuUtama();
    mulaiAnimasiTeksSelamatDatang();
    muatSemuaData();
    updateConnectionStatus();
    setInterval(updateConnectionStatus, 5000);

    // Event delegation untuk tombol copy di tabel
    document.addEventListener('click', function(e) {
        if (e.target.closest('.teks-copy')) {
            const button = e.target.closest('.teks-copy');
            const textToCopy = button.getAttribute('data-copy');
            salinKeClipboard(textToCopy, button, () => tampilkanNotifikasi('Data copied!', 'sukses'));
        }
    });
};

// =============== ALL DATA VIEW FUNCTIONS ===============
// ... (fungsi all data view tetap sama) ...

// =============== SIDEBAR TOGGLE ===============
// ... (fungsi sidebar toggle tetap sama) ...

// =============== DATA LOADING FROM GOOGLE APPS SCRIPT ===============
async function muatSemuaData() {
    tampilkanLoading(true);

    try {
        // Load data dari Google Apps Script
        const response = await fetch(GAS_URL);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();

        if (data.success) {
            // Format data sesuai dengan struktur yang diharapkan
            semuaData = {
                datalogin: data.datalogin || [],
                linknawala: data.linknawala || []
            };

            console.log('Data loaded successfully:', semuaData);

            // Render tables untuk setiap kategori
            renderAllTables();

            tampilkanNotifikasi("All data loaded successfully!", "sukses");
        } else {
            throw new Error(data.error || 'Unknown error from server');
        }

    } catch (error) {
        console.error("Error loading data:", error);
        tampilkanNotifikasi("Failed to load data: " + error.message, "error");

        // Fallback: coba load data dari CSV jika GAS gagal
        muatDataFallback();
    } finally {
        tampilkanLoading(false);
    }
}

function renderAllTables() {
    // Render table untuk setiap kategori
    const categories = ['datalogin', 'linknawala'];

    categories.forEach((kategori, index) => {
        const elementId = `data${index + 1}`;
        const data = semuaData[kategori];

        if (data && data.length > 0) {
            document.getElementById(elementId).innerHTML = buatTabel(data, kategori);
        } else {
            document.getElementById(elementId).innerHTML = buatPesanError(kategori, new Error('No data available'));
        }
    });
}

// ... (fallback dan fungsi bantuan lainnya tetap sama) ...

// =============== TABLE CREATION ===============
function buatTabel(data, kategori) {
    if (!data || data.length < 2) {
        return `
        <div class="table-header">
            <div class="table-title">${getNamaKategori(kategori)}</div>
            <div class="table-actions">
                <button class="table-copy-btn" onclick="muatDataKategori('${kategori}')">
                    <i class="fas fa-redo"></i> Reload Data
                </button>
            </div>
        </div>
        <div style="text-align:center;padding:40px;color:var(--text-muted);">
            <i class="fas fa-database" style="font-size:3rem;margin-bottom:20px;"></i>
            <h3>No Data Available</h3>
            <p>No data found for this category</p>
        </div>`;
    }

    let tableHTML = `
    <div class="table-header">
        <div class="table-title">${getNamaKategori(kategori)}</div>
        <div class="table-actions">
            <button class="table-copy-btn" onclick="salinTabel('${kategori}')">
                <i class="fas fa-copy"></i> Copy Data
            </button>
            <button class="table-copy-btn" onclick="eksporKeFile('${kategori}')">
                <i class="fas fa-download"></i> Export
            </button>
            <button class="table-copy-btn" onclick="muatDataKategori('${kategori}')">
                <i class="fas fa-redo"></i> Reload
            </button>
        </div>
    </div>
    <div class="table-container"><table>`;

    // SAMA UNTUK SEMUA KATEGORI - Standard table structure
    tableHTML += '<tr>';
    if (data[0]) {
        data[0].forEach(header => {
            tableHTML += `<th>${escapeHTML(header)}</th>`;
        });
        tableHTML += '<th>Actions</th>';
        tableHTML += '</tr>';

        for (let i = 1; i < data.length; i++) {
            if (!data[i]) continue;

            tableHTML += '<tr>';
            data[i].forEach((cell, cellIndex) => {
                const cellContent = escapeHTML(cell) || '-';
                // Jika ini adalah kolom pertama, berikan styling khusus
                if (cellIndex === 0) {
                    tableHTML += `<td class="kolom-pertanyaan">
                        <div style="display: flex; align-items: flex-start; gap: 10px;">
                            <i class="fas fa-question-circle" style="color: var(--primary); margin-top: 2px;"></i>
                            <div>${cellContent}</div>
                        </div>
                    </td>`;
                } 
                // Jika ini adalah kolom kedua, berikan styling khusus
                else if (cellIndex === 1) {
                    tableHTML += `<td class="kolom-penyelesaian">
                        <div style="display: flex; align-items: flex-start; gap: 10px;">
                            <i class="fas fa-check-circle" style="color: var(--accent); margin-top: 2px;"></i>
                            <div>${cellContent}</div>
                        </div>
                    </td>`;
                }
                // Untuk kolom lainnya
                else {
                    tableHTML += `<td>${cellContent}</td>`;
                }
            });
            
            // Tambahkan sel kosong jika data memiliki kolom lebih sedikit dari header
            while (data[i].length < data[0].length) {
                tableHTML += '<td>-</td>';
            }
            
            // Tombol actions - menggunakan data attribute untuk menyimpan teks yang akan disalin
            const secondCell = escapeSpecialChars(data[i][1] || '');
            
            tableHTML += `
            <td style="vertical-align: middle; text-align: center;">
                <span class="teks-copy" data-copy="${secondCell}"
                    style="font-size: 0.9em; padding: 8px 15px; cursor: pointer;"
                    title="Copy Data to Clipboard">
                    <i class="fas fa-copy" style="margin-right: 5px;"></i>COPY
                </span>
            </td>`;
            tableHTML += '</tr>';
        }
    }

    if (!tableHTML.includes('<tr>') || tableHTML.match(/<tr>/g).length <= 2) {
        tableHTML += '<tr><td colspan="4" style="text-align:center;padding:40px;color:#ff3366;">No data available for this category</td></tr>';
    }

    tableHTML += '</table></div>';

    return tableHTML;
}

// =============== SEARCH FUNCTIONS ===============
// Gunakan debounce untuk pencarian
const cariTabel = debounce(function() {
    if (sedangMencari) return;

    const input = document.getElementById('kotakPencarian').value.toLowerCase().trim();
    document.getElementById('pesanTidakDitemukan').style.display = 'none';

    if (input.length < 2) {
        if (kategoriSekarang === 'all') {
            renderAllDataView();
        } else {
            tampilkanSemuaTabel();
        }
        return;
    }

    sedangMencari = true;

    setTimeout(() => {
        let ditemukan = false;

        if (kategoriSekarang === 'all') {
            // Search in all data view
            const filteredData = {};
            Object.keys(semuaData).forEach(kategori => {
                const data = semuaData[kategori];
                if (data && data.length > 1) {
                    const hasilFilter = filterData(data, input);
                    if (hasilFilter.length > 1) {
                        filteredData[kategori] = hasilFilter;
                        ditemukan = true;
                    }
                }
            });

            if (ditemukan) {
                renderFilteredAllDataView(filteredData);
            }
        } else {
            // Search in individual categories
            document.querySelectorAll('#data1, #data2').forEach(el => {
                el.style.display = 'none';
            });

            const categories = ['datalogin', 'linknawala'];
            categories.forEach((kategori, index) => {
                const data = semuaData[kategori];
                if (data && data.length > 1) {
                    const hasilFilter = filterData(data, input);
                    if (hasilFilter.length > 1) {
                        const elementId = `data${index + 1}`;
                        document.getElementById(elementId).style.display = 'block';
                        document.getElementById(elementId).innerHTML = buatTabel(hasilFilter, kategori);
                        ditemukan = true;
                    }
                }
            });
        }

        if (!ditemukan && input.length > 0) {
            document.getElementById('pesanTidakDitemukan').style.display = 'block';
        }

        sedangMencari = false;
    }, 300);
}, 300); // Debounce 300ms

// ... (fungsi bantuan dan utility lainnya tetap sama) ...

// =============== UTILITY FUNCTIONS ===============
function escapeHTML(str) {
    if (!str) return '';
    return str.toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/\n/g, '<br>');
}

function escapeSpecialChars(text) {
    if (!text) return '';
    return text.toString()
        .replace(/\\/g, '\\\\')
        .replace(/'/g, "\\'")
        .replace(/"/g, '\\"')
        .replace(/\n/g, '\\n')
        .replace(/\r/g, '\\r')
        .replace(/\t/g, '\\t');
}

// =============== COPY FUNCTIONS ===============
function salinTabel(kategori) {
    const data = semuaData[kategori];
    if (!data || data.length === 0) {
        tampilkanNotifikasi("No data to copy", "peringatan");
        return;
    }

    const csvData = data.map(row =>
        row.map(cell => `"${(cell || '').replace(/"/g, '""')}"`).join(',')
    ).join('\n');

    salinKeClipboard(csvData, null, () => {
        tampilkanNotifikasi("Table data copied to clipboard!", "sukses");
    });
}

function salinKeClipboard(text, element, callback) {
    const textarea = document.createElement('textarea');
    textarea.value = text
        .replace(/\\'/g, "'")
        .replace(/\\"/g, '"')
        .replace(/\\n/g, '\n')
        .replace(/\\r/g, '\r')
        .replace(/\\t/g, '\t')
        .replace(/\\\\/g, '\\');
    
    textarea.style.position = 'fixed';
    document.body.appendChild(textarea);
    textarea.select();

    try {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(textarea.value).then(() => {
                if (element) tampilkanFeedbackSalin(element, true);
                if (callback) callback();
            }).catch(() => {
                fallbackSalin(textarea, element, callback);
            });
        } else {
            fallbackSalin(textarea, element, callback);
        }
    } catch (err) {
        console.error("Copy failed:", err);
        if (element) tampilkanFeedbackSalin(element, false);
    } finally {
        document.body.removeChild(textarea);
    }
}

function fallbackSalin(textarea, element, callback) {
    try {
        const success = document.execCommand('copy');
        if (element) tampilkanFeedbackSalin(element, success);
        if (callback && success) callback();
    } catch (err) {
        console.error("Fallback copy failed:", err);
        if (element) tampilkanFeedbackSalin(element, false);
    }
}

function tampilkanFeedbackSalin(element, isSuccess) {
    const originalHTML = element.innerHTML;

    element.innerHTML = isSuccess
        ? '<i class="fas fa-check"></i> Copied!'
        : '<i class="fas fa-times"></i> Error!';
    element.classList.add('disalin');

    setTimeout(() => {
        element.innerHTML = originalHTML;
        element.classList.remove('disalin');
    }, 2000);
}

// ... (fungsi navigasi dan lainnya tetap sama) ...

// =============== WELCOME TEXT ANIMATION ===============
function mulaiAnimasiTeksSelamatDatang() {
    const teksSelamatDatang = document.getElementById('teksSelamatDatang');
    const texts = ["Welcome to Tommy Dashboard"];
    let count = 0;
    let index = 0;
    let isDeleting = false;
    let speed = 1000;

    function type() {
        const currentText = texts[count];

        if (isDeleting) {
            teksSelamatDatang.textContent = currentText.substring(0, index - 1);
            index--;
            speed = 50;
        } else {
            teksSelamatDatang.textContent = currentText.substring(0, index + 1);
            index++;
            speed = 150;
        }

        if (!isDeleting && index === currentText.length) {
            isDeleting = true;
            speed = 2000;
        } else if (isDeleting && index === 0) {
            isDeleting = false;
            count = (count + 1) % texts.length;
            speed = 500;
        }

        setTimeout(type, speed);
    }

    type();
}

// =============== CONNECTION STATUS UPDATE ===============
function updateConnectionStatus() {
    const statusElement = document.getElementById('connection-status');
    const indicator = document.querySelector('.status-indicator-small');
    const latency = Math.floor(Math.random() * 100) + 50;

    statusElement.textContent = `${latency} ms`;

    indicator.className = 'status-indicator-small';
    if (latency < 100) {
        indicator.classList.add('good');
    } else if (latency < 200) {
        indicator.classList.add('status-indicator-medium');
    } else {
        indicator.classList.add('status-indicator-bad');
    }
}

// Add CSS animations for notifications
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);
</script>
</body>
</html>
